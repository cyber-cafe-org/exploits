const express = require('express')
const cookieParser = require('cookie-parser')
const escape = require('escape-html')
const serialize = require('node-serialize')

const app = express()
app.use(cookieParser())

app.get('/', function (req, res) {
  if (req.cookies.profile) {
    const str = Buffer.from(req.cookies.profile, 'base64').toString()
    const obj = serialize.unserialize(str)
    if (obj.username) {
      res.send('Hello ' + escape(obj.username))
    }
  } else {
    res.cookie('profile', 'eyJ1c2VybmFtZSI6ImVtcmUiLCJjb3VudHJ5IjoidHVya2V5IiwiY2l0eSI6ImFua2FyYSJ9', {
      maxAge: 900000,
      httpOnly: true
    })
    res.send('Hello World')
  }
})
app.listen(3000, console.log("server is listening at port: 3000"))
